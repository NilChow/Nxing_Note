### 如何保证消息不丢失

##### 生产者

###### 同步Producer

​	配置ACK参数，ACK是 Producer 在确认一个请求发送完成之前需要收到的反馈信息的数量。 这个参数是为了保证发送请求的可靠性

|   配置   |                             功能                             |                            安全性                            |               分析               |
| :------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :------------------------------: |
|  acks=0  | producer 不会等待服务器的反馈。该消息会被立刻添加到 socket buffer 中并认为已经发送完成 |                  不能保证服务器是否收到请求                  |        高可用但吞吐量变低        |
|  acks=1  | leader节点会将记录写入本地日志，并且在所有 follower 节点反馈之前就先确认成功 | leader 节点在接收记录之后，并且在 follower 节点复制数据完成之前产生错误，则这条记录会丢失 |               折中               |
| acks=all | leader 节点会等待所有同步中的副本确认之后再确认这条记录是否发送完成 | 只要至少有一个同步副本存在，记录就不会丢失。这种方式是对请求传递的最有效保证 | 高吞吐，但需要忍受部分数据的丢失 |



###### 异步Producer

​	通过buffer来控制数据的发送，主要有时间阈值和消息的数量阈值两个参数；

​	如果buffer满了，消息还没有发出去，假如设置的是立即清理模式，风险很大，要设置成阻塞。



##### 消费者

###### 自动offset

​	自动提交offset，可能会导致数据丢失。

​	比如一次pull了30条数据，在处理第20条的时候自动提交了offset，但是在处理21条时出现了异常，那么再次pull数据的时候，由于offset是30，所以从30条后开始拉取，那么中间这10条数据就丢失了

###### 手动维护offset

​	手动维护offset可以保证数据不被丢失，但是每处理一条消息都提交offset会很影响性能，所以可以选择批次提交的形式。



##### 如何保证不重复消费

1.  如果是时序数据采用时序型数据库
2.  添加unique key